/*
 * citrus-overlay.dts
 */

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pinctrl/bcm2835.h>

/dts-v1/;
/plugin/;

/ {
	compatible = "brcm,bcm2835";

	fragment@0 {
		target-path = "/";
		__overlay__ {
			citrus {
				/* Core driver multiplexes SPI and I2C */
				compatible = "citrus-core";
				#address-cells = <1>;
				#size-cells = <0>;

				/* Set bias for I2C compatibility */
				sck-gpios = <&gpio 11 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN | GPIO_PULL_UP)>;
				sck2-gpios = <&gpio 26 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN | GPIO_PULL_UP)>;
				mosi-gpios = <&gpio 10 (GPIO_ACTIVE_HIGH | GPIO_OPEN_DRAIN | GPIO_PULL_UP)>;

				spi {
					compatible = "spi-citrus";
					#address-cells = <1>;
					#size-cells = <0>;

					cs-gpios = <&gpio 18 GPIO_ACTIVE_LOW>;

					panel: display@0 {
						compatible = "pimoroni,hyperpixel2round";
						reg = <0>;
						/* 100 kHz */
						spi-max-frequency = <100000>;
						backlight = <&backlight>;
						rotation = <0>;

						port {
							panel_in: endpoint {
								remote-endpoint = <&dpi_out>;
							};
						};
					};
				};

				i2c {
					compatible = "i2c-citrus";
					i2c-gpio,delay-us = <4>;        /* ~100 kHz */
					#address-cells = <1>;
					#size-cells = <0>;

					polytouch: edt-ft5x06@15 {
						#address-cells = <1>;
						#size-cells = <0>;
						compatible = "edt,edt-ft5406";
						reg = <0x15>;
						interrupt-parent = <&gpio>;
						interrupts = <27 0x02>; /* IRQF_TRIGGER_FALLING */
						touchscreen-size-x = <240>;
						touchscreen-size-y = <240>;
					};
				};

				/* This node is optional */
				i2c2 {
					compatible = "i2c-citrus2";
					i2c-gpio,delay-us = <4>;        /* ~100 kHz */
					#address-cells = <1>;
					#size-cells = <0>;

					bno055@28 {
						#address-cells = <1>;
						#size-cells = <0>;
						compatible = "bosch,bno055";
						reg = <0x28>;
					};
				};
			};

			backlight: backlight {
				compatible = "pwm-backlight";
				pinctrl-0 = <&pwm1_gpio19>;
				pinctrl-names = "default";
				pwms = <&pwm 1 5000000 0>;
			};
		};
	};

	fragment@1 {
		target = <&dpi>;
		__overlay__  {
			status = "okay";

			pinctrl-names = "default";
			pinctrl-0 = <&dpi_18bit_cpadhi_gpio0>;

			port {
				dpi_out: endpoint {
					remote-endpoint = <&panel_in>;
				};
			};
		};
	};

	fragment@2 {
		target = <&pwm>;
		__overlay__  {
			status = "okay";
		};
	};

	__overrides__ {
		disable-touch = <0>,"-3";
		touchscreen-inverted-x = <&polytouch>,"touchscreen-inverted-x?";
		touchscreen-inverted-y = <&polytouch>,"touchscreen-inverted-y!";
		touchscreen-swapped-x-y = <&polytouch>,"touchscreen-swapped-x-y!";
		rotate = <&panel>, "rotation:0";
	};

};
